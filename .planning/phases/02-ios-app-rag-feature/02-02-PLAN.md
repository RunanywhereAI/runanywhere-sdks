---
phase: 02-ios-app-rag-feature
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - examples/ios/RunAnywhereAI/RunAnywhereAI/Features/RAG/Views/DocumentRAGView.swift
  - examples/ios/RunAnywhereAI/RunAnywhereAI/App/ContentView.swift
autonomous: true
requirements: [APP-01, APP-02, APP-03, APP-04]

must_haves:
  truths:
    - "User can tap a button to open the system document picker and select a PDF or JSON file"
    - "After selecting a file, the app shows loading state then confirms document is loaded"
    - "User can type a question and tap send to receive an answer grounded in the loaded document"
    - "User can ask follow-up questions without re-picking the document"
    - "RAG feature is accessible from the app's tab navigation"
  artifacts:
    - path: "examples/ios/RunAnywhereAI/RunAnywhereAI/Features/RAG/Views/DocumentRAGView.swift"
      provides: "Full RAG UI: document picker trigger, loading state, Q&A chat interface"
      contains: "fileImporter"
    - path: "examples/ios/RunAnywhereAI/RunAnywhereAI/App/ContentView.swift"
      provides: "Updated tab bar with RAG feature accessible via More hub"
      contains: "DocumentRAGView"
  key_links:
    - from: "DocumentRAGView.swift"
      to: "RAGViewModel.swift"
      via: "@State var viewModel = RAGViewModel()"
      pattern: "RAGViewModel"
    - from: "ContentView.swift"
      to: "DocumentRAGView.swift"
      via: "NavigationLink in MoreHubView"
      pattern: "DocumentRAGView"
---

<objective>
Create the SwiftUI view for the RAG document Q&A feature and wire it into the app's navigation. Users will be able to pick a document, see it load, ask questions, and get answers — all in one view.

Purpose: Complete the user-facing RAG feature by connecting the RAGViewModel (Plan 01) to a SwiftUI interface and making it discoverable in the app.
Output: DocumentRAGView.swift (the RAG screen), updated ContentView.swift (navigation entry point).
</objective>

<execution_context>
@/Users/guruvyas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guruvyas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ios-app-rag-feature/02-01-SUMMARY.md

# ViewModel this view binds to
@examples/ios/RunAnywhereAI/RunAnywhereAI/Features/RAG/ViewModels/RAGViewModel.swift

# Existing UI patterns to follow
@examples/ios/RunAnywhereAI/RunAnywhereAI/Features/Chat/Views/ChatInterfaceView.swift
@examples/ios/RunAnywhereAI/RunAnywhereAI/App/ContentView.swift
@examples/ios/RunAnywhereAI/RunAnywhereAI/Core/DesignSystem/AppColors.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DocumentRAGView with document picker and Q&A interface</name>
  <files>examples/ios/RunAnywhereAI/RunAnywhereAI/Features/RAG/Views/DocumentRAGView.swift</files>
  <action>
Create `DocumentRAGView.swift` in `Features/RAG/Views/`.

This is a single SwiftUI view that handles the entire RAG flow. Use `@State private var viewModel = RAGViewModel()`.

**Layout structure** (vertical, simple):

1. **Top section — Document status bar:**
   - If no document loaded: show a prominent "Select Document" button with `doc.badge.plus` SF Symbol
   - If loading: show `ProgressView` with "Loading document..." text
   - If loaded: show document name with a green checkmark icon, and a "Change Document" button (smaller, secondary style)

2. **Middle section — Messages list (ScrollView):**
   - If no document loaded AND no messages: show an empty state explaining "Pick a PDF or JSON document to start asking questions"
   - If document loaded but no messages: show a prompt like "Document loaded. Ask a question below."
   - Otherwise: render messages in a vertical scroll, user messages right-aligned with accent background, assistant messages left-aligned with secondary background. Use the app's existing `AppColors` for consistency.
   - Auto-scroll to bottom when new messages appear (use `ScrollViewReader` with `.onChange` of `viewModel.messages.count`)

3. **Bottom section — Input bar:**
   - `TextField` for the question, "Send" button (SF Symbol `arrow.up.circle.fill`)
   - Disabled when `!viewModel.isDocumentLoaded` or `viewModel.isQuerying`
   - On submit: call `Task { await viewModel.askQuestion() }`
   - Show a small `ProgressView` inline when `viewModel.isQuerying`

4. **Error display:**
   - If `viewModel.error` is non-nil, show an alert or inline error banner (prefer inline banner below the document status bar, dismissible)

**Document picker:**
Use SwiftUI's `.fileImporter` modifier (available iOS 14+). Configure it for:
- `allowedContentTypes: [.pdf, .json]` (import `UniformTypeIdentifiers`)
- `allowsMultipleSelection: false`
- On result: extract URL from `Result`, call `Task { await viewModel.loadDocument(url: url, config: ragConfig) }`

For the `RAGConfiguration`, create it with placeholder model paths for now. The RAG pipeline needs embedding and LLM model paths. Use string constants at the top of the file or a simple helper — these will be wired to the app's actual model manager paths in a future iteration. Example:
```swift
private var ragConfig: RAGConfiguration {
    RAGConfiguration(
        embeddingModelPath: "",  // Placeholder — real path from model manager
        llmModelPath: ""         // Placeholder — real path from model manager
    )
}
```

**Navigation:** Wrap content in a `NavigationView` with `.navigationTitle("Document Q&A")`.

**Cleanup:** Use `.onDisappear { Task { await viewModel.clearDocument() } }` to tear down the pipeline when leaving the view. Actually, do NOT destroy on disappear — the user may navigate away and come back. Instead, only clear when user explicitly taps "Change Document" (which calls `clearDocument()` then opens picker again).

Follow the app's existing design system: use `AppColors`, `AppSpacing` where they exist. Keep the UI clean and minimal — this is an MVP.
  </action>
  <verify>
Build: `cd examples/ios/RunAnywhereAI && xcodebuild build -scheme RunAnywhereAI -destination 'platform=iOS Simulator,name=iPhone 16 Pro' -quiet 2>&1 | tail -5`. Build succeeds. Grep for `fileImporter` and `RAGViewModel` in DocumentRAGView.swift.
  </verify>
  <done>DocumentRAGView renders document picker (APP-01), shows loading/loaded state, displays Q&A messages (APP-03), and supports follow-up questions without re-picking (APP-04).</done>
</task>

<task type="auto">
  <name>Task 2: Wire DocumentRAGView into ContentView MoreHubView</name>
  <files>examples/ios/RunAnywhereAI/RunAnywhereAI/App/ContentView.swift</files>
  <action>
Add a `NavigationLink` to `MoreHubView` in `ContentView.swift` for the RAG feature.

Add it as the first item in the existing "Utilities" section (or create a new section above it called "Documents" if that reads better — use your judgment):

```swift
NavigationLink {
    DocumentRAGView()
} label: {
    FeatureRow(
        icon: "doc.text.magnifyingglass",
        iconColor: .indigo,
        title: "Document Q&A",
        subtitle: "Ask questions about PDF and JSON documents"
    )
}
```

Place it before the existing Transcribe/Speak/Storage links in the list. The `doc.text.magnifyingglass` SF Symbol visually represents document search, and `.indigo` gives it a distinct color from existing items.

No other changes to ContentView.swift.
  </action>
  <verify>
Build: `cd examples/ios/RunAnywhereAI && xcodebuild build -scheme RunAnywhereAI -destination 'platform=iOS Simulator,name=iPhone 16 Pro' -quiet 2>&1 | tail -5`. Build succeeds. Grep for `DocumentRAGView` in ContentView.swift to confirm wiring.
  </verify>
  <done>DocumentRAGView is accessible from the More tab via a NavigationLink. User can navigate to the RAG feature from the main app navigation.</done>
</task>

</tasks>

<verification>
1. `xcodebuild build` succeeds for the iOS example app
2. DocumentRAGView uses `.fileImporter` for PDF and JSON selection (APP-01)
3. DocumentRAGView shows document loaded state and supports follow-up queries (APP-04)
4. Q&A messages render with user questions and assistant answers (APP-03)
5. ContentView's MoreHubView contains a NavigationLink to DocumentRAGView
6. No NSLock, no mock implementations
</verification>

<success_criteria>
- User can navigate to Document Q&A from More tab
- Document picker opens for PDF/JSON files (APP-01)
- After loading, user can type questions and see answers (APP-03)
- Document stays loaded across multiple queries (APP-04)
- Build succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-ios-app-rag-feature/02-02-SUMMARY.md`
</output>
