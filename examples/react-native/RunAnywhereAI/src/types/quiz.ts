/**
 * Quiz Types - Matching iOS QuizViewModel.swift
 *
 * Reference: examples/ios/RunAnywhereAI/RunAnywhereAI/Features/Quiz/QuizViewModel.swift
 */

/**
 * Quiz question generated by the LLM
 */
export interface QuizQuestion {
  /** Unique identifier */
  id: string;

  /** The question text */
  question: string;

  /** Correct answer (true/false) */
  correctAnswer: boolean;

  /** Explanation of the correct answer */
  explanation: string;
}

/**
 * Generated quiz from LLM structured output
 */
export interface QuizGeneration {
  /** Array of quiz questions */
  questions: QuizQuestion[];

  /** Topic of the quiz */
  topic: string;

  /** Difficulty level */
  difficulty: 'easy' | 'medium' | 'hard';
}

/**
 * JSON Schema for structured output generation
 */
export const QUIZ_JSON_SCHEMA = {
  type: 'object',
  properties: {
    questions: {
      type: 'array',
      items: {
        type: 'object',
        properties: {
          id: { type: 'string' },
          question: { type: 'string' },
          correctAnswer: { type: 'boolean' },
          explanation: { type: 'string' },
        },
        required: ['id', 'question', 'correctAnswer', 'explanation'],
      },
    },
    topic: { type: 'string' },
    difficulty: { type: 'string', enum: ['easy', 'medium', 'hard'] },
  },
  required: ['questions', 'topic', 'difficulty'],
} as const;

/**
 * User's answer to a quiz question
 */
export interface QuizAnswer {
  /** Unique identifier */
  id: string;

  /** ID of the question answered */
  questionId: string;

  /** User's answer (true/false) */
  userAnswer: boolean;

  /** Whether the answer was correct */
  isCorrect: boolean;

  /** Time spent on this question in milliseconds */
  timeSpent: number;
}

/**
 * Quiz session data
 */
export interface QuizSession {
  /** Unique identifier */
  id: string;

  /** Generated quiz data */
  generatedQuiz: QuizGeneration;

  /** User's answers */
  answers: QuizAnswer[];

  /** Session start time */
  startTime: Date;

  /** Session end time (when quiz completed) */
  endTime?: Date;
}

/**
 * Computed quiz session helpers
 */
export function isQuizComplete(session: QuizSession): boolean {
  return session.answers.length === session.generatedQuiz.questions.length;
}

export function getQuizScore(session: QuizSession): number {
  return session.answers.filter(a => a.isCorrect).length;
}

export function getQuizPercentage(session: QuizSession): number {
  if (session.generatedQuiz.questions.length === 0) return 0;
  return (getQuizScore(session) / session.generatedQuiz.questions.length) * 100;
}

/**
 * Quiz results data
 */
export interface QuizResults {
  /** The completed session */
  session: QuizSession;

  /** Total time spent on the quiz in milliseconds */
  totalTimeSpent: number;

  /** Questions answered incorrectly */
  incorrectQuestions: QuizQuestion[];
}

/**
 * Swipe direction for quiz cards
 */
export enum SwipeDirection {
  Left = 'left',
  Right = 'right',
  None = 'none',
}

/**
 * Quiz view state machine
 */
export enum QuizViewState {
  Input = 'input',
  Generating = 'generating',
  Quiz = 'quiz',
  Results = 'results',
}

/**
 * Quiz generation error types
 */
export enum QuizGenerationErrorType {
  NoQuestionsGenerated = 'no_questions_generated',
  InvalidJSONFormat = 'invalid_json_format',
  ParsingFailed = 'parsing_failed',
  SDKGenerationFailed = 'sdk_generation_failed',
  NoModelLoaded = 'no_model_loaded',
  Timeout = 'timeout',
}

/**
 * Quiz generation error
 */
export interface QuizGenerationError {
  type: QuizGenerationErrorType;
  message: string;
  detail?: string;
}

/**
 * Quiz constants
 */
export const QUIZ_CONSTANTS = {
  /** Maximum input characters */
  MAX_INPUT_CHARACTERS: 12000,

  /** Minimum number of questions */
  MIN_QUESTIONS: 3,

  /** Maximum number of questions */
  MAX_QUESTIONS: 10,

  /** Swipe threshold in pixels */
  SWIPE_THRESHOLD: 100,

  /** Generation timeout in seconds */
  GENERATION_TIMEOUT_SECONDS: 120,

  /** Default generation temperature */
  DEFAULT_TEMPERATURE: 0.7,

  /** Default max tokens */
  DEFAULT_MAX_TOKENS: 1500,
} as const;

/**
 * Calculate estimated question count based on input length
 */
export function estimateQuestionCount(inputText: string): number {
  const estimatedTokens = inputText.length / 4;
  const baseCount = Math.floor(estimatedTokens / 300);
  return Math.min(
    Math.max(QUIZ_CONSTANTS.MIN_QUESTIONS, baseCount),
    QUIZ_CONSTANTS.MAX_QUESTIONS
  );
}

/**
 * Generation hints for structured output
 */
export const QUIZ_GENERATION_HINTS = {
  temperature: QUIZ_CONSTANTS.DEFAULT_TEMPERATURE,
  maxTokens: QUIZ_CONSTANTS.DEFAULT_MAX_TOKENS,
  systemRole: 'educational quiz generator',
} as const;
