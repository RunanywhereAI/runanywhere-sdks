# Tests - OpenClaw Hybrid Assistant

Two test binaries cover different levels of the assistant pipeline. Both are built automatically with `./build.sh` or via CMake.

## Prerequisites

```bash
# From the openclaw-hybrid-assistant directory
./build.sh
# Or manually:
mkdir -p build && cd build && cmake .. -DCMAKE_BUILD_TYPE=Release && cmake --build . -j$(nproc)
```

Models must be downloaded before running tests:

```bash
./scripts/download-models.sh --wakeword
```

Test WAV files are generated by:

```bash
./tests/scripts/generate-test-audio.sh
```

---

## 1. Component Tests (`test-components`)

Tests individual voice pipeline components (wake word, VAD, STT) using pre-recorded WAV files. Each test loads the real ONNX models and processes audio offline.

### Run

```bash
# Run the full suite
./build/test-components --run-all

# Individual tests
./build/test-components --test-wakeword <wav>       # Expect wake word detected
./build/test-components --test-no-wakeword <wav>    # Expect NO wake word
./build/test-components --test-vad-stt <wav>        # Test VAD + STT transcription
./build/test-components --test-full <wav>            # Full pipeline: wake word + VAD + STT
./build/test-components --test-wakeword-only <wav>   # Wake word only (should NOT send transcription)
./build/test-components --test-noise <wav>           # Noise only (should NOT trigger anything)
```

### What `--run-all` covers

| Section | Tests | What it verifies |
|---------|-------|-----------------|
| Wake word rejection | Noise, white noise, silence, random words, similar-sounding words | None of these trigger a false wake word detection |
| VAD + STT | Speech audio, silence | Speech is transcribed correctly, silence produces nothing |
| Pipeline rejection | Noise, silence, random speech (no wake word) | Nothing reaches OpenClaw without a valid wake word |
| Wake word pipeline | TTS "Hey Jarvis" + speech, TTS "Hey Jarvis" only | Informational - TTS audio may not match human voice model |

### Test Audio

Located in `tests/audio/`:

| File | Description |
|------|-------------|
| `hey-jarvis-real.wav` | Real human "Hey Jarvis" recording |
| `hey-jarvis-amplified.wav` | Amplified version of the above |
| `edge-cases/hey-jarvis-*.wav` | Variations: fast, slow, high pitch, low pitch, repeated |
| `edge-cases/hey-marcus.wav` | Similar-sounding word (should NOT trigger) |
| `edge-cases/hey-travis.wav` | Similar-sounding word (should NOT trigger) |
| `edge-cases/*-noise.wav` | Brown noise, loud noise, quiet noise |
| `edge-cases/tone-1khz.wav` | Pure 1kHz tone |
| `edge-cases/*-command.wav` | Speech commands (time, weather) without wake word |

---

## 2. Integration Tests (`test-integration`)

End-to-end tests that include a **fake OpenClaw WebSocket server**, the waiting chime, TTS synthesis, and text sanitization. Tests the full assistant flow without needing a real OpenClaw instance.

> **Note:** Requires >8GB RAM due to ONNX runtime. Run on the Pi, not in Docker.

### Run

```bash
# Run the full suite
./build/test-integration --run-all

# Individual test sections
./build/test-integration --test-chime             # Waiting chime only (no models needed)
./build/test-integration --test-sanitization      # Text sanitization for TTS
./build/test-integration --test-tts               # TTS synthesis on various texts
./build/test-integration --test-openclaw-flow     # Full flow with fake server (5s default delay)

# Custom response delay
./build/test-integration --test-openclaw-flow --delay 30    # 30-second delay
./build/test-integration --test-openclaw-flow --delay 1     # 1-second delay (fast response)
```

### What `--run-all` covers

| Section | Tests | What it verifies |
|---------|-------|-----------------|
| **Waiting Chime - Timing** | Start/stop latency, double-start/stop safety, no audio leak after stop | Chime produces audio within 500ms of `start()`, stops within ~50ms of `stop()`, no audio after stop |
| **Waiting Chime - Audio Content** | Tone amplitude, silence gap, no clipping | Generated tone has correct amplitude (20-30% range), silence portion is truly silent |
| **Text Sanitization** | 14 cases: markdown, emoji, special chars, HTML tags, brackets, backslashes, symbol-only input | Clean text produces TTS audio; purely symbolic input is stripped to empty (no audio) |
| **TTS Synthesis** | 5 response types: simple, long, numbers, short, question | Each produces valid audio output |
| **OpenClaw Flow (5s)** | Fake WS server with 5s delay | Chime plays during wait, stops on response, TTS speaks response, message content matches |
| **OpenClaw Flow (15s)** | Fake WS server with 15s delay | Same as above with longer wait (multiple chime loops) |
| **OpenClaw Flow (1s)** | Fake WS server with 1s delay | Fast response - chime starts and stops quickly |

### Fake OpenClaw Server

The integration test includes a `FakeOpenClawServer` class that:
1. Listens on an auto-assigned local port (no conflicts)
2. Completes a real WebSocket handshake
3. Receives `connect` and `transcription` messages
4. Waits the configured delay (simulating OpenClaw thinking/tool usage)
5. Sends back a `speak` response with realistic text

No external server or network needed - everything runs locally in the test process.

---

## Test Scripts

Located in `tests/scripts/`:

| Script | Description |
|--------|-------------|
| `generate-test-audio.sh` | Generates test WAV files using `sox` and `espeak` |
| `extensive-test.sh` | Runs a comprehensive test sweep across all audio files |
| `record-wakeword.sh` | Records wake word samples from the microphone for testing |
