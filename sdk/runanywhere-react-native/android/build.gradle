buildscript {
    ext.kotlin_version = '1.9.22'
    repositories {
        google()
        mavenCentral()
    }

    dependencies {
        classpath 'com.android.tools.build:gradle:8.1.4'
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
    }
}

// =============================================================================
// Native Library Configuration
// =============================================================================
def NATIVE_VERSION = "0.0.1-dev.e0bac69"

apply plugin: 'com.android.library'
apply plugin: 'kotlin-android'

// Apply Nitrogen autolinking
apply from: file("nitrogen/generated/android/runanywhere+autolinking.gradle")

def getExtOrDefault(name) {
    return rootProject.ext.has(name) ? rootProject.ext.get(name) : project.properties['RunAnywhere_' + name]
}

def getExtOrIntegerDefault(name) {
    return rootProject.ext.has(name) ? rootProject.ext.get(name) : (project.properties['RunAnywhere_' + name]).toInteger()
}

def supportsNamespace() {
    def parsed = com.android.Version.ANDROID_GRADLE_PLUGIN_VERSION.tokenize('.')
    def major = parsed[0].toInteger()
    def minor = parsed[1].toInteger()
    return (major == 7 && minor >= 3) || major >= 8
}

// =============================================================================
// Download Native Libraries Task
// =============================================================================
def nativeLibsDir = file("${projectDir}/src/main/jniLibs")
def tmpDir = file("${buildDir}/tmp/native-libs")

task downloadNativeLibs {
    description = "Downloads RunAnywhere native libraries for Android"

    outputs.dir(nativeLibsDir)

    doLast {
        // Check if already downloaded
        if (file("${nativeLibsDir}/arm64-v8a/librunanywhere_llamacpp.so").exists()) {
            println "Native libraries already exist, skipping download."
            return
        }

        // Create directories
        tmpDir.mkdirs()
        nativeLibsDir.mkdirs()
        file("${nativeLibsDir}/arm64-v8a").mkdirs()

        // Download and extract native libraries
        def nativeUrl = "https://github.com/RunanywhereAI/runanywhere-binaries/releases/download/v${NATIVE_VERSION}/RunAnywhereCore-android.zip"
        def nativeZip = file("${tmpDir}/RunAnywhereCore-android.zip")

        println "Downloading native libraries from: ${nativeUrl}"
        try {
            ant.get(src: nativeUrl, dest: nativeZip, verbose: true)
            
            println "Extracting native libraries..."
            ant.unzip(src: nativeZip, dest: tmpDir)

            // Copy all .so files to jniLibs
            println "Copying native libraries to jniLibs..."
            fileTree(tmpDir).matching {
                include "**/*.so"
            }.each { soFile ->
                def relativePath = tmpDir.toPath().relativize(soFile.toPath()).toString()
                def targetPath
                if (relativePath.contains("arm64-v8a")) {
                    def idx = relativePath.indexOf("arm64-v8a")
                    targetPath = relativePath.substring(idx)
                } else {
                    targetPath = "arm64-v8a/${soFile.name}"
                }
                def targetFile = file("${nativeLibsDir}/${targetPath}")
                targetFile.parentFile.mkdirs()
                ant.copy(file: soFile, tofile: targetFile)
                println "  Copied: ${soFile.name} -> ${targetPath}"
            }

            tmpDir.deleteDir()
            println "Native libraries installed successfully!"
        } catch (Exception e) {
            println "Warning: Could not download native libraries: ${e.message}"
            println "The build will use local libraries if available."
        }
    }
}

// Ensure native libs are downloaded before build
tasks.matching { it.name.startsWith('compile') || it.name.startsWith('merge') }.all {
    dependsOn downloadNativeLibs
}

android {
    if (supportsNamespace()) {
        namespace "com.runanywhere.reactnative"

        sourceSets {
            main {
                manifest.srcFile "src/main/AndroidManifestNew.xml"
            }
        }
    }

    compileSdkVersion getExtOrIntegerDefault('compileSdkVersion')

    defaultConfig {
        minSdkVersion getExtOrIntegerDefault('minSdkVersion')
        targetSdkVersion getExtOrIntegerDefault('targetSdkVersion')

        // NDK ABI filters - only include arm64 for now
        ndk {
            abiFilters "arm64-v8a"
        }

        // CMake configuration for C++ HybridObject
        externalNativeBuild {
            cmake {
                cppFlags "-std=c++20", "-fexceptions", "-frtti", "-DANDROID"
                arguments "-DANDROID_STL=c++_shared"
            }
        }
    }

    buildFeatures {
        buildConfig true
        prefab true
    }

    // CMake build configuration
    externalNativeBuild {
        cmake {
            path "CMakeLists.txt"
            version "3.22.1"
        }
    }

    buildTypes {
        release {
            minifyEnabled false
        }
    }

    lintOptions {
        disable 'GradleCompatible'
    }

    // Handle duplicate libc++_shared.so
    packaging {
        jniLibs {
            pickFirst '**/libc++_shared.so'
        }
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }

    kotlinOptions {
        jvmTarget = '17'
    }

    sourceSets {
        main {
            jniLibs.srcDirs = ['src/main/jniLibs']
        }
    }
}

repositories {
    mavenCentral()
    google()
}

dependencies {
    // React Native core dependencies
    implementation "com.facebook.react:react-android"
    implementation "com.facebook.react:hermes-android"
    
    // Kotlin
    implementation "org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version"
    
    // Nitrogen runtime
    implementation "com.margelo.nitro:core:0.31.3"
}
