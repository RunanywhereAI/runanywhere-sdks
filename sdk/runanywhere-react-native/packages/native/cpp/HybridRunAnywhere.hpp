/**
 * HybridRunAnywhere.hpp
 *
 * Nitrogen HybridObject implementation for RunAnywhere SDK.
 * This single C++ file works on both iOS and Android.
 *
 * REFACTORED: Now delegates to modular bridges that use the rac_* API
 * from runanywhere-commons, matching Swift's CppBridge pattern.
 *
 * The HybridRunAnywhereSpec base class is auto-generated by Nitrogen
 * from src/specs/RunAnywhere.nitro.ts
 */

#pragma once

// Include the generated spec header (created by nitrogen)
#if __has_include(<NitroModules/HybridObject.hpp>)
#include "HybridRunAnywhereSpec.hpp"
#else
// Fallback include path during development
#include "../nitrogen/generated/shared/c++/HybridRunAnywhereSpec.hpp"
#endif

#include <mutex>
#include <string>

namespace margelo::nitro::runanywhere {

/**
 * HybridRunAnywhere - Main native implementation
 *
 * Implements the RunAnywhere interface defined in RunAnywhere.nitro.ts
 * Delegates to modular bridges that call runanywhere-commons rac_* API.
 */
class HybridRunAnywhere : public HybridRunAnywhereSpec {
public:
  HybridRunAnywhere();
  ~HybridRunAnywhere();

  // ============================================================================
  // SDK Lifecycle
  // ============================================================================

  std::shared_ptr<Promise<bool>> createBackend(const std::string& name) override;
  std::shared_ptr<Promise<bool>> initialize(const std::string& configJson) override;
  std::shared_ptr<Promise<void>> destroy() override;
  std::shared_ptr<Promise<bool>> isInitialized() override;
  std::shared_ptr<Promise<std::string>> getBackendInfo() override;

  // ============================================================================
  // Text Generation (LLM) - Delegates to LLMBridge
  // ============================================================================

  std::shared_ptr<Promise<bool>> loadTextModel(
    const std::string& path,
    const std::optional<std::string>& configJson) override;
  std::shared_ptr<Promise<bool>> isTextModelLoaded() override;
  std::shared_ptr<Promise<bool>> unloadTextModel() override;
  std::shared_ptr<Promise<std::string>> generate(
    const std::string& prompt,
    const std::optional<std::string>& optionsJson) override;
  std::shared_ptr<Promise<std::string>> generateStream(
    const std::string& prompt,
    const std::string& optionsJson,
    const std::function<void(const std::string&, bool)>& callback) override;
  std::shared_ptr<Promise<bool>> cancelGeneration() override;

  // ============================================================================
  // Speech-to-Text (STT) - Delegates to STTBridge
  // ============================================================================

  std::shared_ptr<Promise<bool>> loadSTTModel(
    const std::string& path,
    const std::string& modelType,
    const std::optional<std::string>& configJson) override;
  std::shared_ptr<Promise<bool>> isSTTModelLoaded() override;
  std::shared_ptr<Promise<bool>> unloadSTTModel() override;
  std::shared_ptr<Promise<std::string>> transcribe(
    const std::string& audioBase64,
    double sampleRate,
    const std::optional<std::string>& language) override;
  std::shared_ptr<Promise<std::string>> transcribeFile(
    const std::string& filePath,
    const std::optional<std::string>& language) override;
  std::shared_ptr<Promise<bool>> supportsSTTStreaming() override;

  // ============================================================================
  // Text-to-Speech (TTS) - Delegates to TTSBridge
  // ============================================================================

  std::shared_ptr<Promise<bool>> loadTTSModel(
    const std::string& path,
    const std::string& modelType,
    const std::optional<std::string>& configJson) override;
  std::shared_ptr<Promise<bool>> isTTSModelLoaded() override;
  std::shared_ptr<Promise<bool>> unloadTTSModel() override;
  std::shared_ptr<Promise<std::string>> synthesize(
    const std::string& text,
    const std::string& voiceId,
    double speedRate,
    double pitchShift) override;
  std::shared_ptr<Promise<std::string>> getTTSVoices() override;

  // ============================================================================
  // Utility Functions
  // ============================================================================

  std::shared_ptr<Promise<std::string>> getLastError() override;
  std::shared_ptr<Promise<bool>> extractArchive(
    const std::string& archivePath,
    const std::string& destPath) override;
  std::shared_ptr<Promise<std::string>> getDeviceCapabilities() override;
  std::shared_ptr<Promise<double>> getMemoryUsage() override;

private:
  // Thread safety
  std::mutex initMutex_;

  // State tracking
  std::string lastError_;

  // Helper methods
  void setLastError(const std::string& error);
};

} // namespace margelo::nitro::runanywhere
