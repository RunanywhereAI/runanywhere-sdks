def getExtOrDefault(name) {
    return rootProject.ext.has(name) ? rootProject.ext.get(name) : project.properties['RunAnywhereCore_' + name]
}

// Only arm64-v8a is supported - native libraries are only built for 64-bit ARM
def reactNativeArchitectures() {
    return ["arm64-v8a"]
}

apply plugin: 'com.android.library'
apply plugin: 'kotlin-android'
apply from: '../nitrogen/generated/android/runanywherecore+autolinking.gradle'
apply plugin: 'com.facebook.react'

def getExtOrIntegerDefault(name) {
    if (rootProject.ext.has(name)) {
        return rootProject.ext.get(name)
    } else if (project.properties.containsKey('RunAnywhereCore_' + name)) {
        return (project.properties['RunAnywhereCore_' + name]).toInteger()
    }
    def defaults = [
        'compileSdkVersion': 36,
        'minSdkVersion': 24,
        'targetSdkVersion': 36
    ]
    return defaults[name] ?: 36
}

// =============================================================================
// Version Constants (MUST match Swift Package.swift and iOS Podspec)
// RACommons ONLY - no backend binaries
// =============================================================================
def commonsVersion = "0.1.2"

// =============================================================================
// Binary Source - RACommons from runanywhere-sdks
// =============================================================================
def githubOrg = "RunanywhereAI"
def commonsRepo = "runanywhere-sdks"

// =============================================================================
// testLocal Toggle
// =============================================================================
def useLocalBuild = project.findProperty("runanywhere.testLocal")?.toBoolean() ?:
                    System.getenv("RA_TEST_LOCAL") == "1" ?: false

// Native libraries directory
def jniLibsDir = file("src/main/jniLibs")
def downloadedLibsDir = file("build/downloaded-libs")
def includeDir = file("src/main/include")

// Local runanywhere-commons path (for local builds)
def runAnywhereCommonsDir = file("../../../../runanywhere-commons")

android {
    namespace "com.margelo.nitro.runanywhere.core"

    compileSdkVersion getExtOrIntegerDefault('compileSdkVersion')

    defaultConfig {
        minSdkVersion getExtOrIntegerDefault('minSdkVersion')
        targetSdkVersion getExtOrIntegerDefault('targetSdkVersion')

        ndk {
            abiFilters 'arm64-v8a'
        }

        externalNativeBuild {
            cmake {
                cppFlags "-frtti -fexceptions -Wall -fstack-protector-all"
                arguments "-DANDROID_STL=c++_shared"
                abiFilters 'arm64-v8a'
            }
        }
    }

    externalNativeBuild {
        cmake {
            path "CMakeLists.txt"
        }
    }

    packagingOptions {
        excludes = [
            "META-INF",
            "META-INF/**"
        ]
        pickFirsts = [
            "**/libc++_shared.so",
            "**/libjsi.so",
            "**/libfbjni.so",
            "**/libfolly_runtime.so"
        ]
        jniLibs {
            useLegacyPackaging = true
        }
    }

    buildFeatures {
        buildConfig true
        prefab true
    }

    buildTypes {
        release {
            minifyEnabled false
        }
    }

    lint {
        disable 'GradleCompatible'
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }

    kotlinOptions {
        jvmTarget = "17"
    }

    sourceSets {
        main {
            java.srcDirs += [
                "generated/java",
                "generated/jni"
            ]

            if (useLocalBuild) {
                def commonsDistDir = new File(runAnywhereCommonsDir, "dist/android")
                if (commonsDistDir.exists()) {
                    jniLibs.srcDirs = [commonsDistDir]
                    logger.lifecycle("[RunAnywhereCore] Using LOCAL native libraries from: $commonsDistDir")
                } else {
                    logger.warn("[RunAnywhereCore] Local commons dist not found at: $commonsDistDir")
                }
            } else {
                jniLibs.srcDirs = [jniLibsDir]
            }
        }
    }
}

// =============================================================================
// Download Native Libraries (RACommons ONLY)
// Backend modules (LlamaCPP, ONNX) are downloaded by their respective packages
// =============================================================================

task downloadNativeLibs {
    description = "Downloads RACommons from GitHub releases"
    group = "build setup"

    def versionFile = file("${jniLibsDir}/.version")
    def expectedVersion = commonsVersion

    outputs.dir(jniLibsDir)
    outputs.upToDateWhen {
        versionFile.exists() && versionFile.text.trim() == expectedVersion
    }

    doLast {
        if (useLocalBuild) {
            logger.lifecycle("[RunAnywhereCore] Skipping download - using local build mode")
            return
        }

        def currentVersion = versionFile.exists() ? versionFile.text.trim() : ""
        if (currentVersion == expectedVersion) {
            logger.lifecycle("[RunAnywhereCore] RACommons version $expectedVersion already downloaded")
            return
        }

        logger.lifecycle("[RunAnywhereCore] Downloading RACommons...")
        logger.lifecycle("  Commons Version: $commonsVersion")

        downloadedLibsDir.mkdirs()
        jniLibsDir.deleteDir()
        jniLibsDir.mkdirs()
        includeDir.mkdirs()

        // =============================================================================
        // Download RACommons from runanywhere-sdks
        // =============================================================================
        def commonsUrl = "https://github.com/${githubOrg}/${commonsRepo}/releases/download/commons-v${commonsVersion}/RACommons-android-v${commonsVersion}.zip"
        def commonsZip = file("${downloadedLibsDir}/RACommons.zip")

        logger.lifecycle("\nðŸ“¦ Downloading RACommons...")
        logger.lifecycle("   URL: $commonsUrl")

        try {
            new URL(commonsUrl).withInputStream { input ->
                commonsZip.withOutputStream { output ->
                    output << input
                }
            }
            logger.lifecycle("   Downloaded: ${commonsZip.length() / 1024}KB")

            copy {
                from zipTree(commonsZip)
                into jniLibsDir
            }

            // Copy headers if present in the archive
            def tempExtract = file("${downloadedLibsDir}/temp-commons")
            tempExtract.deleteDir()
            copy {
                from zipTree(commonsZip)
                into tempExtract
            }
            def headersDir = new File(tempExtract, "include")
            if (headersDir.exists()) {
                copy {
                    from headersDir
                    into includeDir
                }
                logger.lifecycle("   âœ… RACommons headers installed")
            }
            tempExtract.deleteDir()

            logger.lifecycle("   âœ… RACommons installed")
        } catch (Exception e) {
            logger.error("âŒ Failed to download RACommons: ${e.message}")
            throw new GradleException("Failed to download RACommons", e)
        }

        // =============================================================================
        // List installed files
        // =============================================================================
        logger.lifecycle("\nðŸ“‹ Installed native libraries:")
        jniLibsDir.listFiles()?.findAll { it.isDirectory() }?.each { abiDir ->
            logger.lifecycle("  ${abiDir.name}/")
            abiDir.listFiles()?.findAll { it.name.endsWith(".so") }?.sort()?.each { soFile ->
                logger.lifecycle("    ${soFile.name} (${soFile.length() / 1024}KB)")
            }
        }

        if (includeDir.exists() && includeDir.listFiles()?.size() > 0) {
            logger.lifecycle("\nðŸ“‹ Installed headers:")
            includeDir.eachFileRecurse { file ->
                if (file.isFile() && file.name.endsWith(".h")) {
                    logger.lifecycle("  ${file.relativePath(includeDir)}")
                }
            }
        }

        versionFile.text = expectedVersion
        logger.lifecycle("\nâœ… RACommons version $expectedVersion installed")
    }
}

if (!useLocalBuild) {
    preBuild.dependsOn downloadNativeLibs

    afterEvaluate {
        tasks.matching {
            it.name.contains("generateCodegen") || it.name.contains("Codegen")
        }.configureEach {
            mustRunAfter downloadNativeLibs
        }
    }
}

task cleanNativeLibs(type: Delete) {
    description = "Removes downloaded native libraries"
    group = "build"
    delete jniLibsDir
    delete downloadedLibsDir
    delete includeDir
}

clean.dependsOn cleanNativeLibs

repositories {
    mavenCentral()
    google()
}

dependencies {
    implementation "com.facebook.react:react-android"
    implementation project(":react-native-nitro-modules")
}
