name: Build and Release RACommons

# =============================================================================
# This workflow builds RACommons release artifacts:
#
# iOS:
#   - RACommons.xcframework (RAC types, services, platform backend)
#
# Android:
#   - librac_commons.so (shared library per ABI)
#   - librac_commons_jni.so (JNI bridge per ABI)
#
# NOTE: Backend XCFrameworks (LlamaCPP, ONNX, WhisperCPP) are now built
# from runanywhere-core. See runanywhere-core's release-rac-backends.yml
#
# =============================================================================

on:
  push:
    tags:
      - 'commons-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 2.0.0)'
        required: true
        type: string
      platforms:
        description: 'Platforms (ios,android,all)'
        required: false
        default: 'all'
        type: string
      dry_run:
        description: 'Dry run (build only, do not publish)'
        required: false
        default: false
        type: boolean

env:
  PUBLIC_REPO_OWNER: 'RunanywhereAI'
  PUBLIC_REPO_NAME: 'runanywhere-binaries'

jobs:
  # ===========================================================================
  # Prepare
  # ===========================================================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      platforms: ${{ steps.parse.outputs.platforms }}

    steps:
      - name: Determine Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/commons-v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Parse Platforms
        id: parse
        run: |
          PLATFORMS="${{ github.event.inputs.platforms || 'all' }}"
          [ "$PLATFORMS" = "all" ] && PLATFORMS="ios,android"
          PLATFORMS_JSON=$(echo "$PLATFORMS" | tr ',' '\n' | jq -R . | jq -sc .)
          echo "platforms=${PLATFORMS_JSON}" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Build iOS XCFramework
  # ===========================================================================
  build-ios:
    name: Build iOS RACommons
    needs: prepare
    if: contains(fromJson(needs.prepare.outputs.platforms), 'ios')
    runs-on: macos-14
    outputs:
      version: ${{ needs.prepare.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Install Dependencies
        run: brew install cmake ninja

      - name: Build RACommons XCFramework
        run: |
          chmod +x scripts/build-rac-commons.sh
          ./scripts/build-rac-commons.sh --ios --release

      - name: Package and Checksum
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          mkdir -p dist/package

          if [ -d "dist/RACommons.xcframework" ]; then
            cd dist
            zip -r "package/RACommons-ios-v${VERSION}.zip" "RACommons.xcframework"
            cd package
            shasum -a 256 "RACommons-ios-v${VERSION}.zip" > "RACommons-ios-v${VERSION}.zip.sha256"
          fi

          echo "=== Build Artifacts ==="
          ls -la dist/
          ls -la dist/package/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-racommons-${{ needs.prepare.outputs.version }}
          path: |
            dist/package/*.zip
            dist/package/*.sha256
          retention-days: 30

  # ===========================================================================
  # Build Android Libraries
  # ===========================================================================
  build-android:
    name: Build Android RACommons (${{ matrix.abi }})
    needs: prepare
    if: contains(fromJson(needs.prepare.outputs.platforms), 'android')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        abi: [arm64-v8a, armeabi-v7a, x86_64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup NDK
        run: |
          source scripts/load-versions.sh
          NDK_VERSION="${ANDROID_NDK_VERSION:-25.2.9519653}"
          echo "y" | sdkmanager --install "ndk;${NDK_VERSION}" --sdk_root=${ANDROID_SDK_ROOT}
          echo "ANDROID_NDK_HOME=${ANDROID_SDK_ROOT}/ndk/${NDK_VERSION}" >> $GITHUB_ENV

      - name: Install CMake
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build

      - name: Build RACommons for ${{ matrix.abi }}
        run: |
          chmod +x scripts/build-rac-commons.sh
          ./scripts/build-rac-commons.sh --android --abi ${{ matrix.abi }} --release

      - name: Package and Checksum
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          ABI="${{ matrix.abi }}"

          mkdir -p dist/package

          if [ -d "dist/android/rac-commons/jniLibs/${ABI}" ]; then
            cd dist/android/rac-commons
            zip -r "../../package/RACommons-android-${ABI}-v${VERSION}.zip" jniLibs/${ABI} include
            cd ../../package
            shasum -a 256 "RACommons-android-${ABI}-v${VERSION}.zip" > "RACommons-android-${ABI}-v${VERSION}.zip.sha256"
          fi

          ls -la dist/package/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-racommons-${{ matrix.abi }}-${{ needs.prepare.outputs.version }}
          path: |
            dist/package/*.zip
            dist/package/*.sha256
          retention-days: 30

  # ===========================================================================
  # Aggregate Android
  # ===========================================================================
  aggregate-android:
    name: Aggregate Android Artifacts
    needs: [prepare, build-android]
    if: contains(fromJson(needs.prepare.outputs.platforms), 'android')
    runs-on: ubuntu-latest

    steps:
      - name: Download All Android Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: android-racommons-*
          path: artifacts
          merge-multiple: false

      - name: Create Combined Package
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"

          COMBINED_DIR="dist/combined/RACommons-android-v${VERSION}"
          mkdir -p "${COMBINED_DIR}/jniLibs"

          for abi_artifact in artifacts/android-racommons-*/; do
            if [ -d "$abi_artifact" ]; then
              for zip in "${abi_artifact}"*.zip; do
                if [ -f "$zip" ]; then
                  unzip -o "$zip" -d "${COMBINED_DIR}/"
                fi
              done
            fi
          done

          cd dist/combined
          zip -r "RACommons-android-v${VERSION}.zip" "RACommons-android-v${VERSION}"
          shasum -a 256 "RACommons-android-v${VERSION}.zip" > "RACommons-android-v${VERSION}.zip.sha256"

          ls -la

      - name: Upload Combined Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-racommons-combined-${{ needs.prepare.outputs.version }}
          path: |
            dist/combined/*.zip
            dist/combined/*.sha256
          retention-days: 30

  # ===========================================================================
  # Publish
  # ===========================================================================
  publish:
    name: Publish to runanywhere-binaries
    needs: [prepare, build-ios, aggregate-android]
    if: |
      always() &&
      (needs.build-ios.result == 'success' || needs.aggregate-android.result == 'success') &&
      github.event.inputs.dry_run != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download iOS Artifact
        uses: actions/download-artifact@v4
        with:
          pattern: ios-racommons-*
          path: artifacts/ios
          merge-multiple: false
        continue-on-error: true

      - name: Download Combined Android Artifact
        uses: actions/download-artifact@v4
        with:
          pattern: android-racommons-combined-*
          path: artifacts/android
          merge-multiple: false
        continue-on-error: true

      - name: Organize Release Assets
        run: |
          mkdir -p release-assets

          find artifacts/ios -name "*.zip" -exec cp {} release-assets/ \; 2>/dev/null || true
          find artifacts/ios -name "*.sha256" -exec cp {} release-assets/ \; 2>/dev/null || true
          find artifacts/android -name "*.zip" -exec cp {} release-assets/ \; 2>/dev/null || true
          find artifacts/android -name "*.sha256" -exec cp {} release-assets/ \; 2>/dev/null || true

          cd release-assets
          cat *.sha256 > checksums.txt 2>/dev/null || true

          echo "Release assets:"
          ls -la

      - name: Checkout Public Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PUBLIC_REPO_OWNER }}/${{ env.PUBLIC_REPO_NAME }}
          token: ${{ secrets.BINARY_REPO_PAT }}
          path: public-repo
          fetch-depth: 0

      - name: Update Public Repository
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          cd public-repo

          mkdir -p releases/commons-v${VERSION}
          cp ../release-assets/*.zip releases/commons-v${VERSION}/ 2>/dev/null || true
          cp ../release-assets/*.sha256 releases/commons-v${VERSION}/ 2>/dev/null || true
          cp ../release-assets/checksums.txt releases/commons-v${VERSION}/ 2>/dev/null || true

          echo "${VERSION}" > LATEST_COMMONS_VERSION

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add -A
          git commit -m "Release RACommons v${VERSION}" || echo "No changes"

      - name: Create Tag and Push
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          cd public-repo
          git tag -a "commons-v${VERSION}" -m "RACommons v${VERSION}" 2>/dev/null || true
          git push origin main --tags
        env:
          GITHUB_TOKEN: ${{ secrets.BINARY_REPO_PAT }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          repository: ${{ env.PUBLIC_REPO_OWNER }}/${{ env.PUBLIC_REPO_NAME }}
          tag_name: commons-v${{ needs.prepare.outputs.version }}
          name: RACommons v${{ needs.prepare.outputs.version }}
          files: |
            release-assets/*.zip
            release-assets/*.sha256
            release-assets/checksums.txt
          body: |
            ## RACommons v${{ needs.prepare.outputs.version }}

            Core commons library for RunAnywhere SDK.

            ### Contents

            - RAC type definitions and headers
            - Service registry and provider infrastructure
            - Event system and logging
            - Model management (download strategies, storage)
            - Platform backend (Apple Foundation Models, System TTS)

            ### iOS/macOS

            `RACommons.xcframework` - Core library with headers

            ### Android

            `RACommons-android-v*.zip` contains:
            - `jniLibs/{abi}/librac_commons.so`
            - `jniLibs/{abi}/librac_commons_jni.so`
            - `include/` headers

            ### Note

            Backend libraries (LlamaCPP, ONNX, WhisperCPP) are released separately.
            See: `backends-v*` releases

            ---
            Built from runanywhere-commons @ ${{ github.sha }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.BINARY_REPO_PAT }}
