name: Lint

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine diff range
        id: diff
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            echo "from=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"
            echo "to=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          FROM="${{ github.event.before }}"
          TO="${{ github.sha }}"

          # Fallback for unusual push payloads (e.g., initial commit)
          if [[ -z "$FROM" || "$FROM" =~ ^0+$ ]]; then
            if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
              FROM="$(git rev-parse HEAD~1)"
            else
              FROM="$(git rev-list --max-parents=0 HEAD)"
            fi
          fi

          echo "from=$FROM" >> "$GITHUB_OUTPUT"
          echo "to=$TO" >> "$GITHUB_OUTPUT"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install pre-commit
        run: python -m pip install --upgrade pip pre-commit

      - name: Run pre-commit (changed files only)
        run: |
          pre-commit run \
            --from-ref "${{ steps.diff.outputs.from }}" \
            --to-ref "${{ steps.diff.outputs.to }}" \
            --show-diff-on-failure \
            --color always

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: clang-format (changed C/C++ files only)
        shell: bash
        run: |
          FROM="${{ steps.diff.outputs.from }}"
          TO="${{ steps.diff.outputs.to }}"

          files=()

          while IFS= read -r f; do
            [[ -f "$f" ]] || continue

            # Skip generated code (avoid fighting generated formatting)
            [[ "$f" == *"/nitrogen/generated/"* ]] && continue

            case "$f" in
              *.c|*.cc|*.cpp|*.cxx|*.h|*.hh|*.hpp|*.hxx)
                files+=("$f")
                ;;
            esac
          done < <(git diff --name-only "$FROM" "$TO" --diff-filter=ACMRTUXB)

          if (( ${#files[@]} == 0 )); then
            echo "No C/C++ files changed."
            exit 0
          fi

          clang-format --version
          clang-format --dry-run --Werror -style=file "${files[@]}"
