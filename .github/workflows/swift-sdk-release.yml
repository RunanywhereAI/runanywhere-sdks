name: Swift SDK Release

# =============================================================================
# Swift SDK Release Workflow
#
# Publishes the RunAnywhere Swift SDK for iOS/macOS.
# The Swift SDK is distributed via Swift Package Manager (SPM).
#
# This workflow:
#   1. Updates the Binaries/ folder with latest backend frameworks
#   2. Creates a release tag
#   3. Updates Package.swift binary targets if needed
#
# Users consume via:
#   .package(url: "https://github.com/RunanywhereAI/runanywhere-sdks", from: "1.0.0")
# =============================================================================

on:
  push:
    tags:
      - 'swift-v*'
  workflow_call:
    inputs:
      version:
        description: 'Version to release'
        required: true
        type: string
      update_binaries:
        description: 'Update binaries from latest backend release'
        required: false
        default: true
        type: boolean
      dry_run:
        description: 'Dry run'
        required: false
        default: false
        type: boolean
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      update_binaries:
        description: 'Update binaries from latest backend release'
        required: false
        default: true
        type: boolean
      dry_run:
        description: 'Dry run (test build only)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

env:
  SDK_DIR: sdk/runanywhere-swift

jobs:
  # ===========================================================================
  # Build and Test Swift SDK
  # ===========================================================================
  build-test:
    name: Build & Test Swift SDK
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/swift-v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/swift-v}"
          elif [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.0-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building Swift SDK v$VERSION"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        working-directory: ${{ env.SDK_DIR }}
        run: swiftlint --strict

      - name: Download iOS Artifacts (if available)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: "*-ios-*"
          path: artifacts/
          merge-multiple: true

      - name: Setup Binaries from Artifacts
        working-directory: ${{ env.SDK_DIR }}
        run: |
          echo "=== Checking for CI artifacts ==="
          echo "Current directory: $(pwd)"
          echo "Workspace root: $GITHUB_WORKSPACE"
          
          # Artifacts are downloaded to GITHUB_WORKSPACE/artifacts/
          ARTIFACTS_DIR="${GITHUB_WORKSPACE}/artifacts"
          
          echo "=== Artifacts directory structure ==="
          find "$ARTIFACTS_DIR" -type d 2>/dev/null | head -30 || echo "No artifacts directory"
          
          echo "=== All files in artifacts (first 50) ==="
          find "$ARTIFACTS_DIR" -type f 2>/dev/null | head -50 || echo "No files found"
          
          echo "=== XCFrameworks in artifacts ==="
          find "$ARTIFACTS_DIR" -name "*.xcframework" -type d 2>/dev/null || echo "No xcframeworks found"
          
          # Clean and recreate Binaries directory
          rm -rf Binaries
          mkdir -p Binaries
          
          # Copy xcframeworks - they might be nested in various subdirectories
          echo "=== Copying xcframeworks ==="
          XCFW_COUNT=0
          while IFS= read -r fw; do
            if [ -n "$fw" ] && [ -d "$fw" ]; then
              fw_name=$(basename "$fw")
              # Check if it's a valid xcframework (has Info.plist)
              if [ -f "$fw/Info.plist" ]; then
                echo "‚úÖ Copying valid xcframework: $fw -> Binaries/$fw_name"
                cp -R "$fw" "Binaries/$fw_name"
                XCFW_COUNT=$((XCFW_COUNT + 1))
              else
                echo "‚ö†Ô∏è Skipping invalid xcframework (no Info.plist): $fw"
              fi
            fi
          done < <(find "$ARTIFACTS_DIR" -name "*.xcframework" -type d 2>/dev/null)
          
          echo "Copied $XCFW_COUNT xcframeworks"
          
          # Also try extracting any zip files
          echo "=== Checking for zip files ==="
          find "$ARTIFACTS_DIR" -name "*.zip" -type f 2>/dev/null | while read zip; do
            echo "Extracting: $zip"
            unzip -o "$zip" -d Binaries/ 2>/dev/null || true
          done
          
          # Move any nested xcframeworks to top level of Binaries
          echo "=== Flattening nested xcframeworks ==="
          find Binaries -mindepth 2 -name "*.xcframework" -type d 2>/dev/null | while read fw; do
            fw_name=$(basename "$fw")
            if [ -f "$fw/Info.plist" ] && [ ! -d "Binaries/$fw_name" ]; then
              echo "Moving nested: $fw -> Binaries/$fw_name"
              mv "$fw" "Binaries/$fw_name"
            fi
          done
          
          echo "=== Binaries directory contents ==="
          ls -la Binaries/ 2>/dev/null || echo "Binaries directory is empty"
          
          # Verify each required framework exists AND has content
          echo "=== Verifying frameworks ==="
          REQUIRED_FRAMEWORKS="RACommons RABackendLLAMACPP RABackendONNX"
          ALL_VALID=true
          for req in $REQUIRED_FRAMEWORKS; do
            FW_PATH="Binaries/${req}.xcframework"
            if [ -d "$FW_PATH" ] && [ -f "$FW_PATH/Info.plist" ]; then
              echo "‚úÖ $req.xcframework is valid"
              ls "$FW_PATH/"
            else
              echo "‚ùå $req.xcframework is missing or invalid"
              ALL_VALID=false
            fi
          done
          
          if [ "$ALL_VALID" = false ]; then
            echo ""
            echo "‚ö†Ô∏è Some frameworks are missing. Setting testLocal = false"
            echo "   This will download frameworks from GitHub releases instead."
            sed -i '' 's/let testLocal = true/let testLocal = false/' Package.swift
          else
            echo ""
            echo "‚úÖ All required frameworks found and valid"
          fi
          
          echo ""
          echo "=== Package.swift testLocal setting ==="
          grep "let testLocal" Package.swift

      - name: Build Swift Package
        working-directory: ${{ env.SDK_DIR }}
        run: swift build -v

      - name: Run Tests
        working-directory: ${{ env.SDK_DIR }}
        run: swift test -v

      - name: Build for iOS Device
        working-directory: ${{ env.SDK_DIR }}
        run: |
          xcodebuild build \
            -scheme RunAnywhere \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.1' \
            -derivedDataPath build

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: swift-sdk-build-${{ steps.version.outputs.version }}
          path: ${{ env.SDK_DIR }}/build/Build/Products/
          retention-days: 7

  # ===========================================================================
  # Update Binaries (Optional)
  # ===========================================================================
  update-binaries:
    name: Update Binaries
    needs: build-test
    if: github.event.inputs.update_binaries == 'true' || github.event_name == 'push'
    runs-on: macos-14
    outputs:
      version: ${{ steps.version.outputs.version }}
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine Version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/swift-v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/swift-v}"
          elif [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.0-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download Latest Backend Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find latest backends release
          LATEST_TAG=$(gh release list --limit 10 | grep "backends-v" | head -1 | awk '{print $1}')
          
          if [ -z "$LATEST_TAG" ]; then
            echo "No backend releases found, using existing binaries"
            exit 0
          fi
          
          echo "Downloading backends from $LATEST_TAG"
          mkdir -p downloads
          
          # Download iOS backends
          gh release download "$LATEST_TAG" \
            --pattern "RABackendLLAMACPP-ios-*.zip" \
            --pattern "RABackendONNX-ios-*.zip" \
            --pattern "RACommons-ios-*.zip" \
            --dir downloads || echo "Some downloads may have failed"
          
          ls -la downloads/

      - name: Extract and Update Binaries
        run: |
          cd downloads
          
          # Extract and copy to SDK Binaries folder
          for zip in *.zip; do
            if [ -f "$zip" ]; then
              echo "Extracting $zip..."
              unzip -o "$zip" -d extracted/
            fi
          done
          
          # Copy XCFrameworks to SDK
          if [ -d extracted ]; then
            find extracted -name "*.xcframework" -type d | while read fw; do
              fw_name=$(basename "$fw")
              echo "Copying $fw_name to SDK Binaries/"
              rm -rf "../${{ env.SDK_DIR }}/Binaries/$fw_name"
              cp -r "$fw" "../${{ env.SDK_DIR }}/Binaries/"
            done
          fi
          
          cd ..
          echo "=== Updated Binaries ==="
          ls -la ${{ env.SDK_DIR }}/Binaries/

      - name: Update VERSION file
        run: |
          echo "${{ steps.version.outputs.version }}" > ${{ env.SDK_DIR }}/VERSION

      - name: Commit Binary Updates
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add ${{ env.SDK_DIR }}/Binaries/ ${{ env.SDK_DIR }}/VERSION
          
          if git diff --staged --quiet; then
            echo "No binary changes to commit"
          else
            git commit -m "chore(swift): update binaries for v${{ steps.version.outputs.version }}"
            git push
          fi

  # ===========================================================================
  # Create Release
  # ===========================================================================
  publish:
    name: Publish Swift SDK Release
    needs: [build-test, update-binaries]
    if: |
      (startsWith(github.ref, 'refs/tags/swift-v') || github.event_name == 'workflow_dispatch') &&
      github.event.inputs.dry_run != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: swift-v${{ needs.update-binaries.outputs.version }}
          name: RunAnywhere Swift SDK v${{ needs.update-binaries.outputs.version }}
          body: |
            ## RunAnywhere Swift SDK v${{ needs.update-binaries.outputs.version }}

            Privacy-first, on-device AI SDK for iOS and macOS.

            ### Installation

            **Swift Package Manager:**
            ```swift
            dependencies: [
                .package(
                    url: "https://github.com/RunanywhereAI/runanywhere-sdks",
                    from: "${{ needs.update-binaries.outputs.version }}"
                )
            ]
            ```

            Then add the products you need:
            ```swift
            .target(
                name: "YourApp",
                dependencies: [
                    .product(name: "RunAnywhere", package: "runanywhere-sdks"),
                    // Optional: Add specific backends
                    .product(name: "LlamaCPPRuntime", package: "runanywhere-sdks"),
                    .product(name: "ONNXRuntime", package: "runanywhere-sdks"),
                ]
            )
            ```

            ### Features
            - üß† **LLM**: On-device text generation via llama.cpp
            - üé§ **STT**: Speech-to-text via Sherpa-ONNX Whisper
            - üîä **TTS**: Text-to-speech via Sherpa-ONNX Piper
            - üéØ **VAD**: Voice activity detection
            - üîí **Privacy**: All processing happens on-device

            ### Requirements
            - iOS 13.0+ / macOS 10.15+
            - Swift 5.9+
            - Xcode 15.0+

            ### Documentation
            See [README](https://github.com/RunanywhereAI/runanywhere-sdks/tree/main/sdk/runanywhere-swift)

            ---
            Built from runanywhere-sdks @ ${{ github.sha }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

