name: Swift SDK Release

# =============================================================================
# Swift SDK Release Workflow
#
# Publishes the RunAnywhere Swift SDK for iOS/macOS.
# The Swift SDK is distributed via Swift Package Manager (SPM).
#
# This workflow:
#   1. Updates the Binaries/ folder with latest backend frameworks
#   2. Creates a release tag
#   3. Updates Package.swift binary targets if needed
#
# Users consume via:
#   .package(url: "https://github.com/RunanywhereAI/runanywhere-sdks", from: "1.0.0")
# =============================================================================

on:
  push:
    tags:
      - 'swift-v*'
  workflow_call:
    inputs:
      version:
        description: 'Version to release'
        required: true
        type: string
      update_binaries:
        description: 'Update binaries from latest backend release'
        required: false
        default: true
        type: boolean
      dry_run:
        description: 'Dry run'
        required: false
        default: false
        type: boolean
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      update_binaries:
        description: 'Update binaries from latest backend release'
        required: false
        default: true
        type: boolean
      dry_run:
        description: 'Dry run (test build only)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

env:
  SDK_DIR: sdk/runanywhere-swift

jobs:
  # ===========================================================================
  # Build and Test Swift SDK
  # ===========================================================================
  build-test:
    name: Build & Test Swift SDK
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/swift-v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/swift-v}"
          elif [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.0-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building Swift SDK v$VERSION"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        working-directory: ${{ env.SDK_DIR }}
        run: swiftlint --strict

      - name: Download iOS Artifacts (if available)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: "*-ios-*"
          path: artifacts/
          merge-multiple: true

      - name: Setup Binaries from Artifacts
        working-directory: ${{ env.SDK_DIR }}
        run: |
          echo "=== Checking for CI artifacts ==="
          echo "Current directory: $(pwd)"
          echo "Workspace root: $GITHUB_WORKSPACE"
          
          # Artifacts are downloaded to GITHUB_WORKSPACE/artifacts/
          ARTIFACTS_DIR="${GITHUB_WORKSPACE}/artifacts"
          
          echo "=== Artifacts directory contents ==="
          ls -la "$ARTIFACTS_DIR" 2>/dev/null || echo "No artifacts directory at $ARTIFACTS_DIR"
          
          echo "=== All files in artifacts ==="
          find "$ARTIFACTS_DIR" -type f 2>/dev/null | head -30 || echo "No files found"
          
          echo "=== XCFrameworks in artifacts ==="
          find "$ARTIFACTS_DIR" -name "*.xcframework" -type d 2>/dev/null || echo "No xcframeworks found"
          
          mkdir -p Binaries
          FOUND_FRAMEWORKS=0
          
          # Copy xcframeworks directly (artifacts are directories, not zips)
          while IFS= read -r fw; do
            if [ -n "$fw" ]; then
              fw_name=$(basename "$fw")
              echo "Copying: $fw -> Binaries/$fw_name"
              cp -r "$fw" "Binaries/$fw_name"
              FOUND_FRAMEWORKS=$((FOUND_FRAMEWORKS + 1))
            fi
          done < <(find "$ARTIFACTS_DIR" -name "*.xcframework" -type d 2>/dev/null)
          
          # Also try extracting zip files if any
          for zip in "$ARTIFACTS_DIR"/*.zip; do
            if [ -f "$zip" ]; then
              echo "Found zip: $zip, extracting..."
              unzip -o "$zip" -d Binaries/ || true
              FOUND_FRAMEWORKS=$((FOUND_FRAMEWORKS + 1))
            fi
          done
          
          # Move any nested xcframeworks to top level
          while IFS= read -r fw; do
            if [ -n "$fw" ]; then
              fw_name=$(basename "$fw")
              fw_parent=$(dirname "$fw")
              if [ "$fw_parent" != "Binaries" ]; then
                echo "Moving nested: $fw -> Binaries/$fw_name"
                mv "$fw" "Binaries/$fw_name" 2>/dev/null || true
              fi
            fi
          done < <(find Binaries -name "*.xcframework" -type d 2>/dev/null)
          
          echo "=== Binaries directory after setup ==="
          ls -la Binaries/ || echo "Binaries directory is empty"
          
          # Check if we have the required frameworks
          REQUIRED_FRAMEWORKS="RACommons RABackendLLAMACPP RABackendONNX"
          MISSING=""
          for req in $REQUIRED_FRAMEWORKS; do
            if [ ! -d "Binaries/${req}.xcframework" ]; then
              MISSING="$MISSING $req"
            fi
          done
          
          if [ -n "$MISSING" ]; then
            echo "âš ï¸ Missing frameworks:$MISSING"
            echo "Setting testLocal = false to download from releases"
            sed -i '' 's/let testLocal = true/let testLocal = false/' Package.swift
          else
            echo "âœ… All required frameworks found"
          fi
          
          echo "=== Package.swift testLocal setting ==="
          grep "let testLocal" Package.swift

      - name: Build Swift Package
        working-directory: ${{ env.SDK_DIR }}
        run: swift build -v

      - name: Run Tests
        working-directory: ${{ env.SDK_DIR }}
        run: swift test -v

      - name: Build for iOS Device
        working-directory: ${{ env.SDK_DIR }}
        run: |
          xcodebuild build \
            -scheme RunAnywhere \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.1' \
            -derivedDataPath build

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: swift-sdk-build-${{ steps.version.outputs.version }}
          path: ${{ env.SDK_DIR }}/build/Build/Products/
          retention-days: 7

  # ===========================================================================
  # Update Binaries (Optional)
  # ===========================================================================
  update-binaries:
    name: Update Binaries
    needs: build-test
    if: github.event.inputs.update_binaries == 'true' || github.event_name == 'push'
    runs-on: macos-14
    outputs:
      version: ${{ steps.version.outputs.version }}
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine Version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/swift-v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/swift-v}"
          elif [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.0-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download Latest Backend Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find latest backends release
          LATEST_TAG=$(gh release list --limit 10 | grep "backends-v" | head -1 | awk '{print $1}')
          
          if [ -z "$LATEST_TAG" ]; then
            echo "No backend releases found, using existing binaries"
            exit 0
          fi
          
          echo "Downloading backends from $LATEST_TAG"
          mkdir -p downloads
          
          # Download iOS backends
          gh release download "$LATEST_TAG" \
            --pattern "RABackendLLAMACPP-ios-*.zip" \
            --pattern "RABackendONNX-ios-*.zip" \
            --pattern "RACommons-ios-*.zip" \
            --dir downloads || echo "Some downloads may have failed"
          
          ls -la downloads/

      - name: Extract and Update Binaries
        run: |
          cd downloads
          
          # Extract and copy to SDK Binaries folder
          for zip in *.zip; do
            if [ -f "$zip" ]; then
              echo "Extracting $zip..."
              unzip -o "$zip" -d extracted/
            fi
          done
          
          # Copy XCFrameworks to SDK
          if [ -d extracted ]; then
            find extracted -name "*.xcframework" -type d | while read fw; do
              fw_name=$(basename "$fw")
              echo "Copying $fw_name to SDK Binaries/"
              rm -rf "../${{ env.SDK_DIR }}/Binaries/$fw_name"
              cp -r "$fw" "../${{ env.SDK_DIR }}/Binaries/"
            done
          fi
          
          cd ..
          echo "=== Updated Binaries ==="
          ls -la ${{ env.SDK_DIR }}/Binaries/

      - name: Update VERSION file
        run: |
          echo "${{ steps.version.outputs.version }}" > ${{ env.SDK_DIR }}/VERSION

      - name: Commit Binary Updates
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add ${{ env.SDK_DIR }}/Binaries/ ${{ env.SDK_DIR }}/VERSION
          
          if git diff --staged --quiet; then
            echo "No binary changes to commit"
          else
            git commit -m "chore(swift): update binaries for v${{ steps.version.outputs.version }}"
            git push
          fi

  # ===========================================================================
  # Create Release
  # ===========================================================================
  publish:
    name: Publish Swift SDK Release
    needs: [build-test, update-binaries]
    if: |
      (startsWith(github.ref, 'refs/tags/swift-v') || github.event_name == 'workflow_dispatch') &&
      github.event.inputs.dry_run != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: swift-v${{ needs.update-binaries.outputs.version }}
          name: RunAnywhere Swift SDK v${{ needs.update-binaries.outputs.version }}
          body: |
            ## RunAnywhere Swift SDK v${{ needs.update-binaries.outputs.version }}

            Privacy-first, on-device AI SDK for iOS and macOS.

            ### Installation

            **Swift Package Manager:**
            ```swift
            dependencies: [
                .package(
                    url: "https://github.com/RunanywhereAI/runanywhere-sdks",
                    from: "${{ needs.update-binaries.outputs.version }}"
                )
            ]
            ```

            Then add the products you need:
            ```swift
            .target(
                name: "YourApp",
                dependencies: [
                    .product(name: "RunAnywhere", package: "runanywhere-sdks"),
                    // Optional: Add specific backends
                    .product(name: "LlamaCPPRuntime", package: "runanywhere-sdks"),
                    .product(name: "ONNXRuntime", package: "runanywhere-sdks"),
                ]
            )
            ```

            ### Features
            - ðŸ§  **LLM**: On-device text generation via llama.cpp
            - ðŸŽ¤ **STT**: Speech-to-text via Sherpa-ONNX Whisper
            - ðŸ”Š **TTS**: Text-to-speech via Sherpa-ONNX Piper
            - ðŸŽ¯ **VAD**: Voice activity detection
            - ðŸ”’ **Privacy**: All processing happens on-device

            ### Requirements
            - iOS 13.0+ / macOS 10.15+
            - Swift 5.9+
            - Xcode 15.0+

            ### Documentation
            See [README](https://github.com/RunanywhereAI/runanywhere-sdks/tree/main/sdk/runanywhere-swift)

            ---
            Built from runanywhere-sdks @ ${{ github.sha }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

