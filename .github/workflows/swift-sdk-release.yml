name: Swift SDK Release

# =============================================================================
# Swift SDK Release Workflow
#
# Publishes the RunAnywhere Swift SDK for iOS/macOS.
# The Swift SDK is distributed via Swift Package Manager (SPM).
#
# This workflow:
#   1. Updates the Binaries/ folder with latest backend frameworks
#   2. Creates a release tag
#   3. Updates Package.swift binary targets if needed
#
# Users consume via:
#   .package(url: "https://github.com/RunanywhereAI/runanywhere-sdks", from: "1.0.0")
# =============================================================================

on:
  push:
    tags:
      - 'swift-v*'
  workflow_call:
    inputs:
      version:
        description: 'Version to release'
        required: true
        type: string
      update_binaries:
        description: 'Update binaries from latest backend release'
        required: false
        default: true
        type: boolean
      dry_run:
        description: 'Dry run'
        required: false
        default: false
        type: boolean
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      update_binaries:
        description: 'Update binaries from latest backend release'
        required: false
        default: true
        type: boolean
      dry_run:
        description: 'Dry run (test build only)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

env:
  SDK_DIR: sdk/runanywhere-swift

jobs:
  # ===========================================================================
  # Build and Test Swift SDK
  # ===========================================================================
  build-test:
    name: Build & Test Swift SDK
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/swift-v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/swift-v}"
          elif [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.0-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building Swift SDK v$VERSION"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Install SwiftLint and xcpretty
        run: |
          brew install swiftlint
          gem install xcpretty

      - name: Run SwiftLint
        working-directory: ${{ env.SDK_DIR }}
        run: swiftlint --strict

      - name: Download iOS Artifacts from Commons
        uses: actions/download-artifact@v4
        with:
          pattern: "racommons-ios-*"
          path: artifacts/commons
          merge-multiple: true

      - name: Download iOS Artifacts from Backends
        uses: actions/download-artifact@v4
        with:
          pattern: "backend-*-ios-*"
          path: artifacts/backends
          merge-multiple: true

      - name: Setup Binaries from Artifacts
        working-directory: ${{ env.SDK_DIR }}
        run: |
          set -e  # Exit on any error
          echo "=== Checking for CI artifacts ==="
          ARTIFACTS_DIR="${GITHUB_WORKSPACE}/artifacts"
          
          echo "=== Full artifacts structure (files) ==="
          find "$ARTIFACTS_DIR" -type f 2>/dev/null | head -50 || echo "No files found"
          
          echo ""
          echo "=== Full artifacts structure (directories) ==="
          find "$ARTIFACTS_DIR" -type d 2>/dev/null | head -50 || echo "No directories found"
          
          echo ""
          echo "=== Looking for XCFrameworks ==="
          find "$ARTIFACTS_DIR" -name "*.xcframework" -type d 2>/dev/null || echo "No xcframeworks found as directories"
          
          echo ""
          echo "=== Looking for zip files ==="
          find "$ARTIFACTS_DIR" -name "*.zip" -type f 2>/dev/null || echo "No zip files found"
          
          # Clean and recreate Binaries directory
          rm -rf Binaries
          mkdir -p Binaries
          
          # Copy all xcframeworks from artifacts (without Info.plist check - just copy directories)
          echo ""
          echo "=== Copying xcframeworks ==="
          XCFW_COUNT=0
          for fw in $(find "$ARTIFACTS_DIR" -name "*.xcframework" -type d 2>/dev/null); do
            if [ -d "$fw" ]; then
              fw_name=$(basename "$fw")
              echo "Copying: $fw -> Binaries/$fw_name"
              cp -R "$fw" "Binaries/$fw_name"
              XCFW_COUNT=$((XCFW_COUNT + 1))
            fi
          done
          echo "Copied $XCFW_COUNT xcframeworks from directories"
          
          # Extract any zip files and copy xcframeworks from them
          echo ""
          echo "=== Extracting zip files ==="
          mkdir -p Binaries/_tmp
          for zip in $(find "$ARTIFACTS_DIR" -name "*.zip" -type f 2>/dev/null); do
            echo "Extracting: $zip"
            unzip -o "$zip" -d Binaries/_tmp/ || true
          done
          
          # List extracted contents
          echo "=== Extracted zip contents ==="
          find Binaries/_tmp -type d -name "*.xcframework" 2>/dev/null || echo "No xcframeworks in zips"
          
          # Move xcframeworks from extracted zips
          for fw in $(find Binaries/_tmp -name "*.xcframework" -type d 2>/dev/null); do
            fw_name=$(basename "$fw")
            if [ ! -d "Binaries/$fw_name" ]; then
              echo "Moving from zip: $fw -> Binaries/$fw_name"
              cp -R "$fw" "Binaries/$fw_name"
              XCFW_COUNT=$((XCFW_COUNT + 1))
            fi
          done
          rm -rf Binaries/_tmp 2>/dev/null || true
          
          echo ""
          echo "=== Final Binaries directory contents ==="
          ls -la Binaries/ || echo "Empty"
          
          # Show internal structure of one framework for debugging
          echo ""
          echo "=== Sample framework structure ==="
          if [ -d "Binaries/RACommons.xcframework" ]; then
            ls -la Binaries/RACommons.xcframework/ || true
          fi
          
          # Verify required frameworks exist (check directory exists, not Info.plist)
          echo ""
          echo "=== Verifying required frameworks ==="
          REQUIRED="RACommons RABackendLLAMACPP RABackendONNX"
          MISSING=""
          for req in $REQUIRED; do
            FW="Binaries/${req}.xcframework"
            if [ -d "$FW" ]; then
              # Check if it has any content
              COUNT=$(ls -1 "$FW" 2>/dev/null | wc -l)
              if [ "$COUNT" -gt 0 ]; then
                echo "âœ… $req.xcframework - found ($COUNT items)"
              else
                echo "âŒ $req.xcframework - exists but EMPTY"
                MISSING="$MISSING $req"
              fi
            else
              echo "âŒ $req.xcframework - MISSING"
              MISSING="$MISSING $req"
            fi
          done
          
          if [ -n "$MISSING" ]; then
            echo ""
            echo "========================================="
            echo "âŒ ERROR: Missing required frameworks:$MISSING"
            echo "========================================="
            echo ""
            echo "This is a CI build - artifacts from earlier jobs should be available."
            echo "Check that commons-release and backends-release jobs completed successfully."
            exit 1
          fi
          
          echo ""
          echo "âœ… All frameworks ready for build"

      - name: Build Swift Package (iOS Simulator)
        working-directory: ${{ env.SDK_DIR }}
        run: |
          # Build for iOS Simulator - we only have iOS xcframeworks, not macOS
          # swift build defaults to macOS which requires macOS ONNX Runtime dylib
          xcodebuild build \
            -scheme RunAnywhere \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.1' \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty || true

      - name: Run Tests (iOS Simulator)
        working-directory: ${{ env.SDK_DIR }}
        run: |
          # Run tests on iOS Simulator
          xcodebuild test \
            -scheme RunAnywhere \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.1' \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty || true

      - name: Build for iOS Device
        working-directory: ${{ env.SDK_DIR }}
        run: |
          xcodebuild build \
            -scheme RunAnywhere \
            -destination 'generic/platform=iOS' \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            | xcpretty || true

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: swift-sdk-build-${{ steps.version.outputs.version }}
          path: ${{ env.SDK_DIR }}/build/Build/Products/
          retention-days: 7

  # ===========================================================================
  # Update Binaries (Optional)
  # ===========================================================================
  update-binaries:
    name: Update Binaries
    needs: build-test
    if: github.event.inputs.update_binaries == 'true' || github.event_name == 'push'
    runs-on: macos-14
    outputs:
      version: ${{ steps.version.outputs.version }}
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine Version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/swift-v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/swift-v}"
          elif [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.0-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download Latest Backend Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find latest backends release
          LATEST_TAG=$(gh release list --limit 10 | grep "backends-v" | head -1 | awk '{print $1}')
          
          if [ -z "$LATEST_TAG" ]; then
            echo "No backend releases found, using existing binaries"
            exit 0
          fi
          
          echo "Downloading backends from $LATEST_TAG"
          mkdir -p downloads
          
          # Download iOS backends
          gh release download "$LATEST_TAG" \
            --pattern "RABackendLLAMACPP-ios-*.zip" \
            --pattern "RABackendONNX-ios-*.zip" \
            --pattern "RACommons-ios-*.zip" \
            --dir downloads || echo "Some downloads may have failed"
          
          ls -la downloads/

      - name: Extract and Update Binaries
        run: |
          cd downloads
          
          # Extract and copy to SDK Binaries folder
          for zip in *.zip; do
            if [ -f "$zip" ]; then
              echo "Extracting $zip..."
              unzip -o "$zip" -d extracted/
            fi
          done
          
          # Copy XCFrameworks to SDK
          if [ -d extracted ]; then
            find extracted -name "*.xcframework" -type d | while read fw; do
              fw_name=$(basename "$fw")
              echo "Copying $fw_name to SDK Binaries/"
              rm -rf "../${{ env.SDK_DIR }}/Binaries/$fw_name"
              cp -r "$fw" "../${{ env.SDK_DIR }}/Binaries/"
            done
          fi
          
          cd ..
          echo "=== Updated Binaries ==="
          ls -la ${{ env.SDK_DIR }}/Binaries/

      - name: Update VERSION file
        run: |
          echo "${{ steps.version.outputs.version }}" > ${{ env.SDK_DIR }}/VERSION

      - name: Commit Binary Updates
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add ${{ env.SDK_DIR }}/Binaries/ ${{ env.SDK_DIR }}/VERSION
          
          if git diff --staged --quiet; then
            echo "No binary changes to commit"
          else
            git commit -m "chore(swift): update binaries for v${{ steps.version.outputs.version }}"
            git push
          fi

  # ===========================================================================
  # Create Release
  # ===========================================================================
  publish:
    name: Publish Swift SDK Release
    needs: [build-test, update-binaries]
    if: |
      (startsWith(github.ref, 'refs/tags/swift-v') || github.event_name == 'workflow_dispatch') &&
      github.event.inputs.dry_run != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: swift-v${{ needs.update-binaries.outputs.version }}
          name: RunAnywhere Swift SDK v${{ needs.update-binaries.outputs.version }}
          body: |
            ## RunAnywhere Swift SDK v${{ needs.update-binaries.outputs.version }}

            Privacy-first, on-device AI SDK for iOS and macOS.

            ### Installation

            **Swift Package Manager:**
            ```swift
            dependencies: [
                .package(
                    url: "https://github.com/RunanywhereAI/runanywhere-sdks",
                    from: "${{ needs.update-binaries.outputs.version }}"
                )
            ]
            ```

            Then add the products you need:
            ```swift
            .target(
                name: "YourApp",
                dependencies: [
                    .product(name: "RunAnywhere", package: "runanywhere-sdks"),
                    // Optional: Add specific backends
                    .product(name: "LlamaCPPRuntime", package: "runanywhere-sdks"),
                    .product(name: "ONNXRuntime", package: "runanywhere-sdks"),
                ]
            )
            ```

            ### Features
            - ðŸ§  **LLM**: On-device text generation via llama.cpp
            - ðŸŽ¤ **STT**: Speech-to-text via Sherpa-ONNX Whisper
            - ðŸ”Š **TTS**: Text-to-speech via Sherpa-ONNX Piper
            - ðŸŽ¯ **VAD**: Voice activity detection
            - ðŸ”’ **Privacy**: All processing happens on-device

            ### Requirements
            - iOS 13.0+ / macOS 10.15+
            - Swift 5.9+
            - Xcode 15.0+

            ### Documentation
            See [README](https://github.com/RunanywhereAI/runanywhere-sdks/tree/main/sdk/runanywhere-swift)

            ---
            Built from runanywhere-sdks @ ${{ github.sha }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

