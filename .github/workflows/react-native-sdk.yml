name: React Native SDK CI

on:
  push:
    branches: [ main ]
    paths:
      - 'sdk/runanywhere-react-native/**'
      - '.github/workflows/react-native-sdk.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'sdk/runanywhere-react-native/**'
      - '.github/workflows/react-native-sdk.yml'

jobs:
  lint-and-build:
    name: Lint, Type Check and Build React Native SDK
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'
        cache-dependency-path: sdk/runanywhere-react-native/yarn.lock

    - name: Install dependencies
      working-directory: ./sdk/runanywhere-react-native
      run: yarn install --frozen-lockfile

    - name: Run ESLint
      working-directory: ./sdk/runanywhere-react-native
      run: yarn lint

    - name: Run TypeScript type check
      working-directory: ./sdk/runanywhere-react-native
      run: yarn typecheck
      continue-on-error: true

    - name: Generate Nitrogen bindings
      working-directory: ./sdk/runanywhere-react-native
      run: yarn nitrogen
      continue-on-error: true

    - name: Build package
      working-directory: ./sdk/runanywhere-react-native
      run: yarn build

  build-ios:
    name: Build iOS Native Module
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_16.2.app

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'
        cache-dependency-path: sdk/runanywhere-react-native/yarn.lock

    - name: Install dependencies
      working-directory: ./sdk/runanywhere-react-native
      run: yarn install --frozen-lockfile

    - name: Detect available iOS simulator
      id: detect-simulator
      run: |
        # Try to find an iPhone simulator with iOS 18.x runtime
        SIMULATOR="$(xcrun simctl list devices available | grep -i "iPhone" | grep -i "iOS 18" | head -1 | sed -E 's/.*\(([^)]+)\).*/\1/' || echo "")"
        if [[ -z "$SIMULATOR" ]]; then
          # Fallback to hardcoded value
          SIMULATOR="iPhone 16"
          echo "Using fallback simulator: ${SIMULATOR}"
        else
          echo "Detected simulator: ${SIMULATOR}"
        fi
        echo "simulator=$SIMULATOR" >> $GITHUB_OUTPUT
        # Determine OS version (default to 18.1)
        OS_VERSION="18.1"
        echo "os_version=$OS_VERSION" >> $GITHUB_OUTPUT

    - name: Build iOS
      working-directory: ./sdk/runanywhere-react-native/ios
      run: |
        pod install
        xcodebuild build \
          -workspace RunAnywhereReactNative.xcworkspace \
          -scheme RunAnywhereReactNative \
          -destination "platform=iOS Simulator,name=${{ steps.detect-simulator.outputs.simulator }},OS=${{ steps.detect-simulator.outputs.os_version }}" \
          -derivedDataPath build
      continue-on-error: true

  build-android:
    name: Build Android Native Module
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'
        cache-dependency-path: sdk/runanywhere-react-native/yarn.lock

    - name: Install dependencies
      working-directory: ./sdk/runanywhere-react-native
      run: yarn install --frozen-lockfile

    - name: Generate Gradle wrapper (if needed)
      working-directory: ./sdk/runanywhere-react-native/android
      run: |
        if [ ! -f "./gradlew" ]; then
          gradle wrapper --gradle-version 8.3 || echo "Gradle wrapper generation skipped (gradle not in PATH)"
        fi

    - name: Build Android
      working-directory: ./sdk/runanywhere-react-native/android
      run: |
        if [ -f "./gradlew" ]; then
          chmod +x ./gradlew
          ./gradlew build
        else
          echo "Warning: gradlew not found, skipping Android build"
        fi
      continue-on-error: true
